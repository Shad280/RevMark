{% extends "base.html" %}
{% block content %}
<style>
.message-sender {
  background: #2d8f3f;
  color: white;
  margin-left: 2rem;
  text-align: right;
}
.message-receiver {
  background: #f8f9fa;
  margin-right: 2rem;
}
</style>

<div class="dashboard">
  <div class="dashboard-header">
    <h1>Chat with {{ receiver.username }}</h1>
    <a href="{{ url_for('main.inbox') }}" class="btn btn-outline">‚Üê Back to Inbox</a>
  </div>
  
  <div class="chat-container" style="background: white; border-radius: 8px; padding: 2rem; margin-bottom: 2rem;">
    <div class="messages-thread" style="max-height: 400px; overflow-y: auto; margin-bottom: 2rem;">
      {% for m in thread %}
        <div class="message-item {% if m.sender.id == current_user.id %}message-sender{% else %}message-receiver{% endif %}" style="margin-bottom: 1rem; padding: 1rem; border-radius: 6px;">
          <div><strong>{{ m.sender.username }}:</strong> {{ m.body }}</div>
          
          {% if m.attachments %}
            <div class="message-attachments" style="margin-top: 0.5rem;">
              {% for attachment in m.attachments %}
                <div class="attachment-item" style="display: inline-block; margin: 0.25rem; padding: 0.5rem; background: rgba(255,255,255,0.1); border-radius: 4px;">
                  {% if attachment.is_image and attachment.download_url %}
                    <a href="{{ attachment.download_url }}" target="_blank">
                      <img src="{{ attachment.download_url }}" alt="{{ attachment.original_filename }}" style="max-width: 200px; max-height: 200px; display: block;">
                    </a>
                  {% elif attachment.download_url %}
                    <a href="{{ attachment.download_url }}" target="_blank">
                      üìé {{ attachment.original_filename }}
                      <small style="display: block; opacity: 0.8;">{{ "%.1f"|format(attachment.file_size/1024) }} KB</small>
                    </a>
                  {% else %}
                    üìé {{ attachment.original_filename }}
                    <small style="display: block; opacity: 0.8;">{{ "%.1f"|format(attachment.file_size/1024) }} KB</small>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          {% endif %}
          
          {# Offer approval UI: Only show to buyer if offer is present and not yet approved/rejected #}
          {% if m.is_offer and current_user.id == m.receiver_id and not m.offer_approved and not m.offer_rejected %}
            <div class="offer-actions" style="margin-top: 1rem;">
              <button type="button" class="btn btn-success" onclick="showApproveModal({{ m.id }})">Approve Offer</button>
              <button type="button" class="btn btn-danger" onclick="rejectOffer({{ m.id }})">Reject Offer</button>
            </div>
          {% elif m.is_offer and m.offer_approved %}
            <div class="offer-status" style="margin-top: 1rem; color: #2d8f3f; font-weight: bold;">Offer Approved. Payment will be released to the seller.</div>
          {% elif m.is_offer and m.offer_rejected %}
            <div class="offer-status" style="margin-top: 1rem; color: #c0392b; font-weight: bold;">Offer Rejected.</div>
          {% endif %}
          <small style="opacity: 0.7;">{{ m.timestamp.strftime('%m/%d %H:%M') }}</small>
        </div>
      {% else %}
        <p style="text-align: center; color: #666;">No messages yet. Start the conversation!</p>
      {% endfor %}
    <!-- Approve Offer Modal -->
    <div id="approveOfferModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); z-index:1000; align-items:center; justify-content:center;">
      <div style="background:white; padding:2rem; border-radius:8px; max-width:400px; margin:auto; text-align:center;">
        <h3>Approve Offer & Release Payment</h3>
        <p>Are you sure you want to approve this offer? <br>By approving, payment will be released to the seller's account.</p>
        <form id="approveOfferForm" method="POST" action="{{ url_for('main.approve_offer') }}">
          <input type="hidden" name="message_id" id="approveOfferMessageId">
          <button type="submit" class="btn btn-success">Yes, Approve & Pay</button>
          <button type="button" class="btn btn-secondary" onclick="hideApproveModal()">Cancel</button>
        </form>
      </div>
    </div>
<script>
function showApproveModal(messageId) {
  document.getElementById('approveOfferMessageId').value = messageId;
  document.getElementById('approveOfferModal').style.display = 'flex';
}
function hideApproveModal() {
  document.getElementById('approveOfferModal').style.display = 'none';
}
function rejectOffer(messageId) {
  if (confirm('Are you sure you want to reject this offer?')) {
    // Submit a POST request to reject the offer
    fetch('{{ url_for('main.reject_offer') }}', {
      method: 'POST',
  headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message_id: messageId })
    }).then(() => { window.location.reload(); });
  }
}
</script>
    </div>
    
    <form method="POST" enctype="multipart/form-data" style="max-width: none; margin: 0; padding: 0; box-shadow: none;">
      <textarea name="body" placeholder="Type your message..." required rows="3" style="margin-bottom: 1rem;"></textarea>
      
      <div style="margin-bottom: 1rem;">
        <label for="attachments" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Attach Files (optional):</label>
        <input type="file" 
               name="attachments" 
               id="attachments" 
               multiple 
               accept=".jpg,.jpeg,.png,.gif,.pdf,.doc,.docx"
               style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
        <small style="color: #666;">Supported: JPG, PNG, GIF, PDF, DOC, DOCX (Max 16MB per file)</small>
      </div>
      
      <button type="submit" class="btn btn-primary">Send Message</button>
    </form>
  </div>
</div>

<script>
// Auto-scroll to bottom of messages
document.addEventListener('DOMContentLoaded', function() {
  var messageThread = document.querySelector('.messages-thread');
  if (messageThread) {
    messageThread.scrollTop = messageThread.scrollHeight;
  }
  
  // File upload preview
  const fileInput = document.getElementById('attachments');
  fileInput.addEventListener('change', function() {
    const files = Array.from(this.files);
    if (files.length > 0) {
      const fileNames = files.map(file => file.name).join(', ');
      console.log('Files selected:', fileNames);
    }
  });
});
</script>
{% endblock %}
